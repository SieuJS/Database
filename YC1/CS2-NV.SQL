CONN SYS/123@LOCALHOST:1521/XEPDB1 AS SYSDBA ;

ALTER SESSION SET CURRENT_SCHEMA = QLDLNB; 
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE ;

CREATE OR REPLACE VIEW UV_GV_XEMTT_PHANCONG 
AS 
SELECT P.*, H.TENHP, H.SOTC, H.STLT, H.STTH,H.SOSVTD,H.MADV FROM PHANCONG P,  HOCPHAN H
WHERE  P.MAHP = H.MAHP AND 'NV'||P.MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;

CREATE OR REPLACE VIEW UV_GV_XEMTT_DANGKY
AS 
SELECT * FROM DANGKY 
WHERE 'NV'||MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;

DROP ROLE GV;
CREATE ROLE GV;
CREATE OR REPLACE TRIGGER TRG_GV_SUADIEM
INSTEAD OF UPDATE 
ON UV_GV_XEMTT_DANGKY
FOR EACH ROW
BEGIN
    UPDATE DANGKY SET DIEMTH = :NEW.DIEMTH WHERE 'NV'||MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER');
    UPDATE DANGKY SET DIEMQT = :NEW.DIEMQT WHERE 'NV'||MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;
    UPDATE DANGKY SET DIEMCK = :NEW.DIEMCK WHERE 'NV'||MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;
    UPDATE DANGKY SET DIEMTK = :NEW.DIEMTK WHERE 'NV'||MAGV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;
END;
/


GRANT SELECT ON UV_GV_XEMTT_DANGKY TO GV;
GRANT SELECT ON UV_GV_XEMTT_PHANCONG TO GV;
GRANT UPDATE (DIEMTH,DIEMTK,DIEMQT, DIEMCK) ON UV_GV_XEMTT_DANGKY TO GV;

EXEC USP_GAN_ROLE_NV(STRROLE  => 'GV', LOAI  => 'Giảng viên');
EXEC USP_GAN_ROLE_NV(STRROLE  => 'NVCB', LOAI  => 'Giảng viên');


