CONN SYS/123@LOCALHOST:1521/XE AS SYSDBA ;

alter session set container = CDB$ROOT;

ALTER SESSION SET CURRENT_SCHEMA = QLDLNB; 
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE ;
-- TAO VIEW DE XEM THONG TIN CUA CHINH MINH

CREATE OR REPLACE VIEW UV_NVCB_XEMTTCN 
AS 
SELECT * FROM NHANSU 
WHERE 'C##NV'||MANV = SYS_CONTEXT('USERENV', 'SESSION_USER') ; 


CREATE OR REPLACE TRIGGER TRG_NVCB_SUA_SODT
INSTEAD OF UPDATE 
ON UV_NVCB_XEMTTCN
FOR EACH ROW
BEGIN 
    UPDATE NHANSU SET DT = :NEW.DT WHERE 'C##NV'||MANV = SYS_CONTEXT('USERENV', 'SESSION_USER') ;
END;
/

CREATE OR REPLACE VIEW UV_NVCB_XEMTT_SV AS 
SELECT * FROM SINHVIEN;

CREATE OR REPLACE VIEW UV_NVCB_XEMTT_DV AS
SELECT * FROM DONVI;

CREATE OR REPLACE VIEW UV_NVCB_XEMTT_HOCPHAN AS 
SELECT * FROM HOCPHAN ;

CREATE OR REPLACE VIEW UV_NVCB_XEMTT_KHMO AS 
SELECT * FROM KHMO;

DROP ROLE NVCB;
CREATE ROLE NVCB;

GRANT SELECT ON UV_NVCB_XEMTTCN TO NVCB;
GRANT SELECT ON UV_NVCB_XEMTT_SV TO NVCB;
GRANT SELECT ON UV_NVCB_XEMTT_DV TO NVCB;
GRANT SELECT ON UV_NVCB_XEMTT_HOCPHAN TO NVCB;
GRANT SELECT ON UV_NVCB_XEMTT_KHMO TO NVCB;

GRANT UPDATE(DT) ON UV_NVCB_XEMTTCN TO NVCB;

exec SYS.USP_GAN_ROLE('NVCB','Nhân viên cơ bản');

DECLARE
    CURSOR CUR IS (
        SELECT
            'C##NV'||MANV
        FROM
            NHANSU
        WHERE
            VAITRO = 'Nhân viên cơ bản'
    );
    STRSQL VARCHAR(2000);
    USR    VARCHAR2(10);
    STRROLE VARCHAR2(10);
    
BEGIN
    STRROLE := 'NVCB';
    OPEN CUR;
    STRSQL := 'alter session set "_ORACLE_SCRIPT" = TRUE';
    EXECUTE IMMEDIATE(STRSQL);
    STRSQL := 'alter session set container = CDB$ROOT';
    EXECUTE IMMEDIATE(STRSQL);    
    LOOP
        FETCH CUR INTO USR;
        EXIT WHEN CUR%NOTFOUND;
        STRSQL:= 'GRANT '
                 ||STRROLE
                 ||' TO '
                 ||USR;
        EXECUTE IMMEDIATE (STRSQL);
    END LOOP;
    STRSQL := 'alter session set "_ORACLE_SCRIPT" = FALSE';
    EXECUTE IMMEDIATE(STRSQL);
    CLOSE CUR;
END;
/


