CONN SYS/123@LOCALHOST:1521/XEPDB1 AS SYSDBA; 

ALTER SESSION SET CURRENT_SCHEMA = QLDLNB; 
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE;

CREATE OR REPLACE VIEW UV_TK_XEMTT_PHANCONG
AS SELECT * FROM PHANCONG ; 

CREATE OR REPLACE VIEW UV_TK_XEMTT_NHANSU
AS SELECT * FROM NHANSU;

CREATE OR REPLACE VIEW UV_TK_XEMTT_SINHVIEN
AS SELECT * FROM SINHVIEN;

CREATE OR REPLACE VIEW UV_TK_XEMTT_DONVI
AS SELECT * FROM DONVI;

CREATE OR REPLACE VIEW UV_TK_XEMTT_HOCPHAN
AS SELECT * FROM HOCPHAN;

CREATE OR REPLACE VIEW UV_TK_XEMTT_DANGKY
AS SELECT * FROM DANGKY;

CREATE OR REPLACE VIEW UV_TK_XEMTT_KHMO
AS SELECT * FROM KHMO;


-- THÊM XOÁ CẬP NHẬT TRÊN  QUAN HỆ PHÂN CÔNG, QUẢN LÝ BỞI VPK
SELECT H.*, D.TENDV FROM HOCPHAN H , DONVI D WHERE H.MADV = D.MADV;

CREATE OR REPLACE TRIGGER TRG_TK_UPD_PHANCONG
INSTEAD OF UPDATE ON UV_TK_XEMTT_PHANCONG
FOR EACH ROW 
BEGIN
    
    UPDATE PHANCONG SET MAGV = :NEW.MAGV WHERE MAHP IN (SELECT MAHP FROM HOCPHAN WHERE MADV IN (
        SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng khoa'))  AND MAGV = :OLD.MAGV ;
    UPDATE PHANCONG SET MAHP = :NEW.MAHP WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng khoa'
            )
        ) AND MAHP = :OLD.MAHP ; 
    UPDATE PHANCONG SET HK = :NEW.HK 
    WHERE 
        MAHP IN (SELECT MAHP FROM HOCPHAN WHERE MADV IN (
        SELECT MADV FROM DONVI WHERE  TENDV = 'Văn phòng khoa')) AND HK = :OLD.HK;
    UPDATE PHANCONG SET NAM = :NEW.NAM WHERE MAHP IN (SELECT MAHP FROM HOCPHAN WHERE MADV IN (
        SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng khoa')) AND NAM = :OLD.NAM;
    UPDATE PHANCONG SET MACT = :NEW.MACT WHERE MAHP = (SELECT MAHP FROM HOCPHAN WHERE MADV IN (
        SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng khoa')) AND MACT = :OLD.MACT ;
END;
/

CREATE OR REPLACE TRIGGER TRG_TK_INS_PHANCONG
INSTEAD OF INSERT ON UV_TK_XEMTT_PHANCONG
FOR EACH ROW
DECLARE
    l_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO l_count
    FROM HOCPHAN
    WHERE MADV IN (
        SELECT MADV
        FROM DONVI
        WHERE TENDV = 'Văn phòng khoa'
    )
    AND MAHP = :NEW.MAHP;
    
    IF l_count > 0 THEN
        INSERT INTO PHANCONG (MAGV, MAHP, HK, NAM, MACT)
        VALUES (:NEW.MAGV, :NEW.MAHP, :NEW.HK, :NEW.NAM, :NEW.MACT);
    ELSE
        RAISE_APPLICATION_ERROR(-20001, 'Invalid MAHP');
    END IF;
END;
/


CREATE OR REPLACE TRIGGER TRG_TK_DEL_PHANCONG
INSTEAD OF DELETE ON UV_TK_XEMTT_PHANCONG
BEGIN 
    DELETE FROM PHANCONG
    WHERE MAHP IN (
        SELECT MAHP 
        FROM HOCPHAN 
        WHERE MADV IN (
            SELECT MADV 
            FROM DONVI 
            WHERE TENDV = 'Văn phòng khoa'
        )
    );
END ;
/

-- THEM XOA SUA TREN NHAN SU 
DROP ROLE TK ;
CREATE ROLE TK;

GRANT SELECT, UPDATE , INSERT, DELETE ON UV_TK_XEMTT_NHANSU TO TK ; 

GRANT SELECT, UPDATE, INSERT, DELETE ON UV_TK_XEMTT_PHANCONG TO TK ; 

GRANT SELECT ON UV_TK_XEMTT_DANGKY TO TK;

GRANT SELECT ON UV_TK_XEMTT_DONVI TO TK;
GRANT SELECT ON UV_TK_XEMTT_KHMO TO TK ;
GRANT SELECT ON UV_TK_XEMTT_SINHVIEN TO TK;
GRANT SELECT ON UV_TK_XEMTT_HOCPHAN TO TK;

-- 


EXEC USP_GAN_ROLE_NV(STRROLE  => 'NVCB' /*IN VARCHAR2*/, LOAI  => 'Trưởng khoa' /*IN VARCHAR2*/)

EXEC USP_GAN_ROLE_NV(STRROLE  => 'GV' /*IN VARCHAR2*/, LOAI  => 'Trưởng khoa' /*IN VARCHAR2*/)

EXEC USP_GAN_ROLE_NV(STRROLE  => 'TK' /*IN VARCHAR2*/, LOAI  => 'Trưởng khoa' /*IN VARCHAR2*/)

SELECT * FROM NHANSU WHERE VAITRO = 'Trưởng khoa';

SELECT * FROM PHANCONG;