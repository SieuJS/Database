CONN SYS/123@LOCALHOST:1521/XE AS SYSDBA ;

ALTER SESSION SET CURRENT_SCHEMA = QLDLNB; 
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE ;

CREATE OR REPLACE VIEW UV_GIAOVU_XEMTT_PHANCONG
AS 
SELECT * FROM PHANCONG ;

CREATE OR REPLACE VIEW UV_GIAOVU_XEMTT_SINHVIEN
AS SELECT * FROM SINHVIEN;

CREATE OR REPLACE VIEW UV_GIAOVU_XEMTT_DONVI
AS SELECT * FROM DONVI;

CREATE OR REPLACE VIEW UV_GIAOVU_XEMTT_HOCPHAN
AS SELECT * FROM HOCPHAN;

CREATE OR REPLACE VIEW UV_GIAOVU_XEMTT_KHMO
AS SELECT * FROM KHMO;


CREATE OR REPLACE TRIGGER TRG_GIAOVU_SUA_PHANCONG
INSTEAD OF UPDATE ON UV_GIAOVU_XEMTT_PHANCONG
FOR EACH ROW
DECLARE
    
BEGIN

    UPDATE PHANCONG SET MAGV = :NEW.MAGV WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng'
        )
    ) AND MAGV = :OLD.MAGV; 
    UPDATE PHANCONG SET MAHP = :NEW.MAHP WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng'
        )
    ) AND MAHP = :OLD.MAHP; 
    UPDATE PHANCONG SET HK = :NEW.HK WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng'
        )
    ) AND HK = :OLD.HK; 
    UPDATE PHANCONG SET NAM = :NEW.NAM WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng'
        )
    ) AND NAM = :OLD.NAM; 
    UPDATE PHANCONG SET MACT = :NEW.MACT WHERE MAHP IN (
        SELECT MAHP FROM HOCPHAN WHERE MADV IN (
            SELECT MADV FROM DONVI WHERE TENDV = 'Văn phòng'
        )
    ) AND MACT = :OLD.MACT; 
END;
/

DROP ROLE GIAOVU;
CREATE ROLE GIAOVU;

GRANT SELECT, UPDATE, DELETE, INSERT ON UV_GIAOVU_XEMTT_SINHVIEN  TO GIAOVU;
GRANT SELECT, UPDATE, DELETE, INSERT ON UV_GIAOVU_XEMTT_DONVI TO GIAOVU;
GRANT SELECT, UPDATE, DELETE, INSERT ON UV_GIAOVU_XEMTT_HOCPHAN TO GIAOVU;
GRANT SELECT, UPDATE, DELETE, INSERT ON UV_GIAOVU_XEMTT_KHMO TO GIAOVU;
GRANT SELECT, UPDATE ON UV_GIAOVU_XEMTT_PHANCONG TO GIAOVU;

EXEC SYS.USP_GAN_ROLE('GIAOVU', 'Giáo vụ');
EXEC SYS.USP_GAN_ROLE('NVCB','Giáo vụ');

